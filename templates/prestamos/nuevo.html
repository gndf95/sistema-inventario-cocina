{% extends "base.html" %}

{% block title %}Nuevo Pr√©stamo - Sistema de Inventario{% endblock %}

{% block content %}
<div class="container-fluid px-2 px-md-4">
    <div class="row">
        <div class="col-12 col-lg-8">
            <h1 class="h3 h2-md mb-4">Registrar Nuevo Pr√©stamo</h1>

            <!-- Informaci√≥n del almac√©n del usuario -->
            {% if area_usuario and area_usuario != 'Todas' %}
            <div class="alert alert-info">
                <i class="fas fa-warehouse"></i>
                <strong>{{ area_usuario }}</strong> - Prestando equipo a las √°reas operativas
            </div>
            {% endif %}

            <form method="POST" id="formPrestamo">
                <!-- Datos del Responsable y √Årea Destino -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Datos del Pr√©stamo</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12 col-md-6">
                                <label for="responsable_nombre" class="form-label">Responsable que Recibe *</label>
                                <input type="text" class="form-control" id="responsable_nombre"
                                       name="responsable_nombre" required
                                       placeholder="Nombre completo del responsable">
                            </div>

                            <!-- NUEVO: √Årea operativa que recibe el equipo -->
                            <div class="col-12 col-md-6">
                                <label for="responsable_area" class="form-label">√Årea que Recibe el Equipo *</label>
                                <select class="form-select" id="responsable_area" name="responsable_area" required>
                                    <option value="">Seleccione el √°rea destino</option>
                                    <option value="Cocina Fr√≠a">üßä Cocina Fr√≠a</option>
                                    <option value="Almac√©n">üè† Almac√©n</option>
                                    <option value="Cocina Caliente">üî• Cocina Caliente</option>
                                    <option value="Reposter√≠a">üßÅ Reposter√≠a</option>
                                    <option value="Panader√≠a">ü•ñ Panader√≠a</option>
                                    <option value="Log√≠stica">üì¶ Log√≠stica</option>
                                    <option value="Ventas">üí∞ Ventas</option>
                                </select>
                                <small class="text-muted">¬øPara qu√© √°rea operativa es este pr√©stamo?</small>
                            </div>

                            <div class="col-12 col-md-6">
                                <label for="responsable_telefono" class="form-label">Tel√©fono de Contacto</label>
                                <input type="tel" class="form-control" id="responsable_telefono"
                                       name="responsable_telefono" placeholder="Ej: 5551234567">
                            </div>

                            <div class="col-12 col-md-6">
                                <label for="fecha_devolucion" class="form-label">Fecha de Devoluci√≥n *</label>
                                <input type="date" class="form-control" id="fecha_devolucion"
                                       name="fecha_devolucion" required>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Motivo del pr√©stamo -->
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12 col-md-6">
                                <label for="motivo" class="form-label">Motivo del Pr√©stamo *</label>
                                <select class="form-select" id="motivo" name="motivo" required>
                                    <option value="">Seleccione un motivo</option>
                                    <option value="operacion_diaria">Operaci√≥n diaria</option>
                                    <option value="evento_especial">Evento especial</option>
                                    <option value="reemplazo_temporal">Reemplazo temporal</option>
                                    <option value="capacitacion">Capacitaci√≥n</option>
                                    <option value="mantenimiento">Por mantenimiento de equipo propio</option>
                                    <option value="produccion_especial">Producci√≥n especial</option>
                                    <option value="otro">Otro</option>
                                </select>
                            </div>

                            <div class="col-12 col-md-6">
                                <label for="evento" class="form-label">Descripci√≥n/Evento</label>
                                <input type="text" class="form-control" id="evento" name="evento"
                                       placeholder="Ej: Banquete para 200 personas">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Selecci√≥n de Equipos del Almac√©n -->
                <div class="card mb-3">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            Equipos Disponibles
                            {% if area_usuario and area_usuario != 'Todas' %}
                            <span class="badge bg-primary ms-2">{{ area_usuario }}</span>
                            {% endif %}
                        </h5>
                        <button type="button" class="btn btn-sm btn-primary" onclick="agregarEquipo()">
                            <i class="fas fa-plus"></i> Agregar Equipo
                        </button>
                    </div>
                    <div class="card-body">
                        {% if equipos %}
                        <div id="listaEquipos">
                            <!-- Primera fila de equipo -->
                            <div class="row g-2 mb-2 equipo-row">
                                <div class="col-12 col-md-7">
                                    <select class="form-select equipo-select" name="equipo_id[]" onchange="actualizarDisponibilidad(this)">
                                        <option value="">Seleccione un equipo</option>
                                        {% for equipo in equipos %}
                                        <option value="{{ equipo.id }}"
                                                data-disponible="{{ equipo.cantidad_disponible }}"
                                                data-codigo="{{ equipo.codigo }}"
                                                data-categoria="{{ equipo.categoria.nombre if equipo.categoria else '' }}">
                                            {{ equipo.nombre }} ({{ equipo.codigo }}) - Disp: {{ equipo.cantidad_disponible }}
                                            {% if equipo.categoria %}
                                            <small class="text-muted">- {{ equipo.categoria.nombre }}</small>
                                            {% endif %}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-8 col-md-3">
                                    <input type="number" class="form-control cantidad-input" name="cantidad[]"
                                           placeholder="Cantidad" min="0" max="0" value="0">
                                </div>
                                <div class="col-4 col-md-2">
                                    <button type="button" class="btn btn-danger w-100" onclick="quitarEquipo(this)" disabled>
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>No hay equipos disponibles en este almac√©n</strong>
                            {% if area_usuario %}
                            <br>Almac√©n: <strong>{{ area_usuario }}</strong>
                            <br>Contacta al administrador para agregar equipos a este almac√©n.
                            {% endif %}
                        </div>
                        {% endif %}

                        {% if equipos %}
                        <div class="alert alert-info mt-3 mb-0">
                            <i class="fas fa-info-circle"></i>
                            <strong>Flujo del pr√©stamo:</strong>
                            {{ area_usuario or 'Almac√©n' }} ‚Üí √Årea operativa seleccionada
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Resumen del pr√©stamo -->
                <div class="card mb-3 d-none" id="resumenPrestamo">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">Resumen del Pr√©stamo</h6>
                    </div>
                    <div class="card-body">
                        <div id="resumenContenido"></div>
                    </div>
                </div>

                <!-- Botones de acci√≥n -->
                {% if equipos %}
                <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-4">
                    <a href="{{ url_for('prestamos') }}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-hand-holding"></i> Registrar Pr√©stamo
                    </button>
                </div>
                {% else %}
                <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-4">
                    <a href="{{ url_for('prestamos') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Volver a Pr√©stamos
                    </a>
                </div>
                {% endif %}
            </form>
        </div>

        <!-- Panel lateral de informaci√≥n -->
        <div class="col-12 col-lg-4 mt-4 mt-lg-0">
            <div class="card bg-light">
                <div class="card-body">
                    <h5 class="card-title">Sistema de Almacenes</h5>

                    {% if area_usuario == 'Almac√©n Compras' %}
                    <div class="alert alert-primary">
                        <h6>üõí Almac√©n Compras</h6>
                        <p class="small mb-0">Utensilios generales, herramientas b√°sicas, contenedores y equipo de preparaci√≥n.</p>
                    </div>

                    {% elif area_usuario == 'Almac√©n Calidad e Higiene' %}
                    <div class="alert alert-success">
                        <h6>üß™ Almac√©n Calidad e Higiene</h6>
                        <p class="small mb-0">Instrumentos de control, medici√≥n, balanzas de precisi√≥n y equipo especializado.</p>
                    </div>

                    {% elif area_usuario == 'Almac√©n Equipo Especial' %}
                    <div class="alert alert-warning">
                        <h6>‚ö° Almac√©n Equipo Especial</h6>
                        <p class="small mb-0">Maquinaria especializada, herramientas t√©cnicas y equipo electr√≥nico.</p>
                    </div>

                    {% else %}
                    <div class="alert alert-info">
                        <h6>üë®‚Äçüíº Acceso Completo</h6>
                        <p class="small mb-0">Tienes acceso a equipos de todos los almacenes.</p>
                    </div>
                    {% endif %}

                    <hr>
                    <h6>7 √Åreas Operativas que Reciben:</h6>
                    <div class="row small">
                        <div class="col-6">
                            <ul class="list-unstyled">
                                <li>üßä Cocina Fr√≠a</li>
                                <li>üè† Almac√©n</li>
                                <li>üî• Cocina Caliente</li>
                                <li>üßÅ Reposter√≠a</li>
                            </ul>
                        </div>
                        <div class="col-6">
                            <ul class="list-unstyled">
                                <li>ü•ñ Panader√≠a</li>
                                <li>üì¶ Log√≠stica</li>
                                <li>üí∞ Ventas</li>
                            </ul>
                        </div>
                    </div>

                    <hr>
                    <h6>Proceso de Pr√©stamo</h6>
                    <ol class="small ps-3">
                        <li>Selecciona el √°rea que recibe</li>
                        <li>Elige equipos de tu almac√©n</li>
                        <li>Establece fecha de devoluci√≥n</li>
                        <li>Se genera comprobante con QR</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Establecer fecha m√≠nima (hoy)
document.addEventListener('DOMContentLoaded', function() {
    const hoy = new Date().toISOString().split('T')[0];
    document.getElementById('fecha_devolucion').setAttribute('min', hoy);
});

// Plantilla para nueva fila de equipo
function agregarEquipo() {
    const container = document.getElementById('listaEquipos');
    const primeraFila = container.querySelector('.equipo-row');
    const nuevaFila = primeraFila.cloneNode(true);

    // Limpiar valores
    nuevaFila.querySelector('select').value = '';
    nuevaFila.querySelector('input[type="number"]').value = '0';
    nuevaFila.querySelector('input[type="number"]').max = '0';
    nuevaFila.querySelector('button').disabled = false;

    container.appendChild(nuevaFila);
    actualizarResumen();
}

// Quitar fila de equipo
function quitarEquipo(btn) {
    btn.closest('.equipo-row').remove();
    actualizarResumen();
}

// Actualizar disponibilidad cuando se selecciona un equipo
function actualizarDisponibilidad(select) {
    const row = select.closest('.equipo-row');
    const cantidadInput = row.querySelector('.cantidad-input');
    const selectedOption = select.options[select.selectedIndex];

    if (select.value) {
        const disponible = parseInt(selectedOption.getAttribute('data-disponible'));
        cantidadInput.max = disponible;
        cantidadInput.min = 1;
        if (cantidadInput.value == 0) cantidadInput.value = 1;
    } else {
        cantidadInput.max = 0;
        cantidadInput.min = 0;
        cantidadInput.value = 0;
    }

    actualizarResumen();
}

// Actualizar resumen del pr√©stamo
function actualizarResumen() {
    const rows = document.querySelectorAll('.equipo-row');
    const resumenDiv = document.getElementById('resumenPrestamo');
    const contenido = document.getElementById('resumenContenido');
    const areaDestino = document.getElementById('responsable_area').value;

    let items = [];
    let totalItems = 0;

    rows.forEach(row => {
        const select = row.querySelector('select');
        const cantidad = parseInt(row.querySelector('input[type="number"]').value) || 0;

        if (select.value && cantidad > 0) {
            const option = select.options[select.selectedIndex];
            const nombreEquipo = option.text.split(' (')[0]; // Solo el nombre, sin c√≥digo
            items.push({
                nombre: nombreEquipo,
                cantidad: cantidad
            });
            totalItems += cantidad;
        }
    });

    if (items.length > 0) {
        resumenDiv.classList.remove('d-none');
        let html = '<div class="row">';
        html += '<div class="col-md-8"><h6>Equipos a Prestar:</h6><ul class="mb-0">';
        items.forEach(item => {
            html += `<li>${item.cantidad} x ${item.nombre}</li>`;
        });
        html += '</ul></div>';
        html += '<div class="col-md-4"><h6>Destino:</h6>';
        if (areaDestino) {
            html += `<span class="badge bg-success fs-6">${areaDestino}</span>`;
        } else {
            html += `<span class="text-muted">Seleccione √°rea</span>`;
        }
        html += '</div></div>';
        html += `<hr><div class="d-flex justify-content-between">`;
        html += `<strong>Total de items: ${totalItems}</strong>`;
        html += `<strong>Desde: {{ area_usuario or 'Almac√©n' }}</strong>`;
        html += `</div>`;
        contenido.innerHTML = html;
    } else {
        resumenDiv.classList.add('d-none');
    }
}

// Validaci√≥n antes de enviar
document.getElementById('formPrestamo').addEventListener('submit', function(e) {
    {% if not equipos %}
    e.preventDefault();
    alert('No tienes equipos disponibles para prestar en este almac√©n.');
    return false;
    {% endif %}

    e.preventDefault();

    // Verificar que hay al menos un equipo seleccionado
    const equiposSeleccionados = Array.from(document.querySelectorAll('.equipo-select'))
        .filter(s => s.value && parseInt(s.closest('.equipo-row').querySelector('.cantidad-input').value) > 0);

    if (equiposSeleccionados.length === 0) {
        alert('Debe seleccionar al menos un equipo con cantidad mayor a 0');
        return false;
    }

    // Verificar que se seleccion√≥ √°rea destino
    const areaDestino = document.getElementById('responsable_area').value;
    if (!areaDestino) {
        alert('Debe seleccionar el √°rea que recibir√° el equipo');
        document.getElementById('responsable_area').focus();
        return false;
    }

    // Verificar fecha
    const fecha = new Date(document.getElementById('fecha_devolucion').value);
    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0);

    if (fecha < hoy) {
        alert('La fecha de devoluci√≥n no puede ser anterior a hoy');
        return false;
    }

    // Confirmaci√≥n final
    if (confirm(`¬øConfirma el pr√©stamo desde {{ area_usuario or 'Almac√©n' }} hacia ${areaDestino}?`)) {
        this.submit();
    }
});

// Actualizar resumen cuando cambia el √°rea destino
document.getElementById('responsable_area').addEventListener('change', actualizarResumen);

// Actualizar al cambiar cantidades
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('cantidad-input')) {
        actualizarResumen();
    }
});
</script>
{% endblock %}